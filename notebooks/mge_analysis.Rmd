```         
```

## MGE Analysis File

```{r}
library(tidyverse)
library(RColorBrewer)
library(ggpubr)
library(plotly)
library(ggfortify)
library(ggrepel)
library(reshape2)
library(patchwork)
library(ggsignif)
library(gridExtra)
library(grid)
```

## ISFinder DB Analysis

#### Load Pertinent Files
```{r}
metadata <- read.csv("metadata.csv", header = TRUE)
MGE_data <- read.delim("ISFinder_genemat.txt", header = TRUE)
MGE_lengths <- read.delim("ISFinder_lengths.txt", header = TRUE)
number_bases <- read.csv("bases_number.csv", header = TRUE)
```

#### Cleaning data
```{r}
# remove insertions sequences if zero across all samples
IS_data <- IS_data %>%
  filter(rowSums(.[, -1]) > 0)

# Delete not present genes in IS_lengths compared to IS_data
IS_lengths <- IS_lengths %>%
  filter(GENE %in% IS_data$GENE)
```

#### Merging Metadata and Normalizing Counts
```{r}
combined_length <- merge (IS_data, IS_lengths, by = "GENE", all.x = TRUE)
combined_bases <- merge(number_bases, metadata, by = "SampleID", all.x = TRUE)

rownames(combined_length) <- combined_length$GENE

combined_length <- combined_length %>% select(-GENE)

# Note: Read length (150 bp) and number of bases in the sample are included, but do not affect relative abundance comparisons across genes or samples
IS_length_norm <- combined_length[, 1:(ncol(combined_length)-1)]  / combined_length$Length
IS_length_norm <- IS_length_norm * 150

IS_length_norm <- IS_length_norm[ , order(names(IS_length_norm))]

# Modify the B column** (Multiply by 10^9)
combined_bases <- combined_bases %>%
  mutate(B_transformed = B * 10^9)

IS_length_norm_t <- t(IS_length_norm)
IS_length_norm_t <- sweep(IS_length_norm_t, 1, combined_bases$B_transformed, FUN = "/")

normalized_IS <- t(IS_length_norm_t)

normalized_IS_df <- as.data.frame(normalized_IS) %>%
  mutate(GENE = rownames(normalized_IS)) %>%
  select(GENE, everything())

long_IS <- normalized_IS_df %>%
  pivot_longer(cols = -GENE, names_to = "SampleID", values_to = "Count")

combined_data <- merge(long_IS,metadata, by = "SampleID", all.x = TRUE)
print(combined_data)

IS_df <- combined_data %>%
  pivot_wider(names_from = GENE, values_from = Count)

print(IS_df)
```

## Plots

### Function Helpers
#### Filter data by hospital
```{r}
filter_hospital_data <- function(data, hospitals = c("A", "B", "C")) {
  list(
    a_data = data %>% filter(hospital == "A"),
    b_data = data %>% filter(hospital == "B"),
    c_data = data %>% filter(hospital == "C")
  )
}
```

#### Get top sequences
```{r}
get_top_sequences <- function(data, n = 10) {
  data %>%
    group_by(SampleID) %>%
    summarise(TotalCount = sum(Count, na.rm = TRUE), .groups = 'drop') %>%
    right_join(data, by = "SampleID") %>%
    mutate(Percentage = (Count / TotalCount) * 100) %>%
    group_by(GENE) %>%
    summarise(AverageAbundance = mean(Percentage, na.rm = TRUE), .groups = 'drop') %>%
    arrange(desc(AverageAbundance)) %>%
    top_n(n, AverageAbundance) %>%
    pull(GENE)
}
```

#### Find common and unique top sequences across hospitals
```{r}
analyze_overlap <- function(top_items_list, item_name) {
  common_items <- Reduce(intersect, top_items_list)
  all_top_items <- unique(unlist(top_items_list))
  unique_items <- setdiff(all_top_items, common_items)
  
  cat(paste("Common", item_name, "across all hospitals:", length(common_items), "\n"))
  cat(paste("Common", item_name, ":", paste(common_items, collapse = ", "), "\n"))
  cat(paste("Non-intersecting", item_name, ":", paste(unique_items, collapse = ", "), "\n\n"))
  
  list(common = common_items, unique = unique_items, all = all_top_items)
}
```

#### Create color mapping
```{r}
create_color_mapping <- function(common_items, unique_items) {
  all_items <- c(common_items, unique_items)
  all_items <- setdiff(all_items, "Others")
  
  total_items <- length(all_items)
  palette <- colorRampPalette(brewer.pal(11, "Spectral"))(total_items)
  color_mapping <- setNames(palette, all_items)
  color_mapping["Others"] <- "#D2B48C"
  
  return(color_mapping)
}
```

#### Create stacked bar plot
```{r}
create_stacked_plot <- function(data, top_items, hospital_name, item_col, color_mapping, 
                               show_legend = FALSE, legend_ncol = 1) {
  total_counts_per_sample <- data %>%
    group_by(SampleID) %>%
    summarise(TotalCount = sum(Count, na.rm = TRUE), .groups = 'drop')
  
  plot_data <- data %>%
    left_join(total_counts_per_sample, by = "SampleID") %>%
    mutate(
      Percentage = (Count / TotalCount) * 100,
      "{item_col}" := ifelse(.data[[item_col]] %in% top_items, .data[[item_col]], "Others")
    )
  
  factor_levels <- c("Others", names(color_mapping)[names(color_mapping) != "Others"])
  existing_levels <- intersect(factor_levels, unique(plot_data[[item_col]]))
  plot_data[[item_col]] <- factor(plot_data[[item_col]], levels = existing_levels)
  
  colors_to_use <- color_mapping[levels(plot_data[[item_col]])]
  colors_to_use <- colors_to_use[!is.na(colors_to_use)]
  
  p <- ggplot(plot_data, aes(x = SampleID, y = Percentage, fill = .data[[item_col]])) +
    geom_bar(stat = "identity", position = "stack", width = 0.7) +
    scale_fill_manual(values = colors_to_use) +
    labs(
      title = hospital_name,
      x = "Sample", 
      y = "Relative Abundance (%)"
    ) +
    theme_light() +
    theme(
      axis.text.x = element_text(size = 16, angle = 0, hjust = 0.5),
      axis.text.y = element_text(size = 16),
      axis.title.x = element_text(size = 18),
      axis.title.y = element_text(size = 18),
      plot.title = element_text(size = 20, face = "bold"),
      legend.title = element_blank(),
      legend.text = element_text(size = 16),
      aspect.ratio = 1
    ) +
    guides(fill = guide_legend(ncol = legend_ncol))
  
  if (!show_legend) {
    p <- p + theme(legend.position = "none")
  }
  
  return(p)
}
```

#### Create legend and plot
```{r}
create_legend_data <- function(common_items, unique_items, item_col) {
  all_items <- c(common_items, unique_items, "Others")
  legend_data <- data.frame(
    SampleID = rep("Sample1", length(all_items)),
    ID = all_items,
    RelativeAbundance = rep(1, length(all_items)),
    hospital = rep("Legend", length(all_items))
  )
  legend_data[[item_col]] <- all_items
  return(legend_data)
}

get_legend <- function(plot) {
  tmp <- ggplot_gtable(ggplot_build(plot))
  leg <- which(sapply(tmp$grobs, function(x) x$name) == "guide-box")
  legend <- tmp$grobs[[leg]]
  return(legend)
}
create_combined_plot <- function(plots, legend_grob, filename, width = 18, height = 5) {
  combined_plot <- grid.arrange(
    arrangeGrob(plots[[1]], plots[[2]], plots[[3]], ncol = 3),
    legend_grob,
    ncol = 2,
    widths = c(0.75, 0.25)
  )
  
  ggsave(filename = filename, plot = combined_plot, width = width, height = height, dpi = 300)
  grid.draw(combined_plot)
  
  return(combined_plot)
}
```

### Generating Plot for IS
```{r}
hospital_data_IS <- filter_hospital_data(combined_data)

top_IS <- list(
  c = get_top_sequences(hospital_data_IS$c_data),
  b = get_top_sequences(hospital_data_IS$b_data),
  a = get_top_sequences(hospital_data_IS$a_data)
)

IS_analysis <- analyze_overlap(top_IS, "ISs")

global_color_mapping_IS <- create_color_mapping(IS_analysis$common, IS_analysis$unique)

IS_plots <- list(
  create_stacked_plot(hospital_data_IS$a_data, top_IS$a, "A", "GENE", 
                     global_color_mapping_IS) + labs(x = ""),
  create_stacked_plot(hospital_data_IS$b_data, top_IS$b, "B", "GENE", 
                     global_color_mapping_IS) + labs(y = ""),
  create_stacked_plot(hospital_data_IS$c_data, top_IS$c, "C", "GENE", 
                     global_color_mapping_IS, legend_ncol = 2) + labs(x = "", y = "")
)

legend_data_IS <- create_legend_data(IS_analysis$common, IS_analysis$unique, "GENE")
legend_plot_IS <- create_stacked_plot(legend_data_IS, IS_analysis$all, "Legend", 
                                        "GENE", global_color_mapping_IS, show_legend = TRUE, legend_ncol = 2)
legend_grob_IS <- get_legend(legend_plot_IS)

combined_plot_genes <- create_combined_plot(IS_plots, legend_grob_IS, "IS.png")
```

## PlasmidFinder DB Analysis

#### Load Pertinent Files
```{r}
metadata <- read.csv("metadata_updated.csv", header = TRUE)
Plasmid_data <- read.delim("PlasmidFinder_genemat.txt", header = TRUE)
Plasmid_lengths <- read.delim("PlasmidFinder_length.txt", header = TRUE)
number_bases <- read.csv("bases_number.csv", header = TRUE)
```

#### Clean data
```{r}
Plasmid_data <- Plasmid_data %>%
  filter(rowSums(.[, -1]) > 0)
Plasmid_lengths <- Plasmid_lengths %>%
  filter(GENE %in% Plasmid_data$GENE)

Plasmid_data$GENE <- sub("_{1,}[^_]*$", "", Plasmid_data$GENE)
Plasmid_lengths$GENE <- sub("_{1,}[^_]*$", "", Plasmid_lengths$GENE)
```

#### Preprocessing
```{r}
combined_length <- merge (Plasmid_data, Plasmid_lengths, by = "GENE", all.x = TRUE)
combined_bases <- merge(number_bases, metadata, by = "SampleID", all.x = TRUE)

rownames(combined_length) <- combined_length$GENE

combined_length <- combined_length %>% select(-GENE)

# Note: Read length (150 bp) and number of bases in the sample are included, but do not affect relative abundance comparisons across genes or samples
Plasmid_length_norm <- combined_length[, 1:(ncol(combined_length)-1)]  / combined_length$Length
Plasmid_length_norm <- Plasmid_length_norm * 150

Plasmid_length_norm <- Plasmid_length_norm[ , order(names(Plasmid_length_norm))]

# Modify the B column** (Multiply by 10^9)
combined_bases <- combined_bases %>%
   mutate(B_transformed = B * 10^9)

Plasmid_length_norm_t <- t(Plasmid_length_norm)
Plasmid_length_norm_t <- sweep(Plasmid_length_norm_t, 1, combined_bases$B_transformed, FUN = "/")

normalized_Plasmid <- t(Plasmid_length_norm_t)

normalized_Plasmid_df <- as.data.frame(normalized_Plasmid) %>%
  mutate(GENE = rownames(normalized_Plasmid)) %>%
  select(GENE, everything())

long_Plasmid <- normalized_Plasmid_df %>%
  pivot_longer(cols = -GENE, names_to = "SampleID", values_to = "Count")

combined_data <- merge(long_Plasmid,metadata, by = "SampleID", all.x = TRUE)
print(combined_data)

combined_data <- combined_data %>%
  mutate(GENE = ifelse(grepl("_", GENE), 
                       substring(GENE, 1, regexpr("_", GENE) - 1),
                       GENE)) 

Plasmid_df <- combined_data %>%
  pivot_wider(names_from = GENE, values_from = Count)

print(Plasmid_df)
```

#### NOTE: Please run the helper functions above before running the code block below

### Generating Plot for Plasmid
```{r}
hospital_data_Plasmid <- filter_hospital_data(combined_data)

top_plasmid <- list(
  c = get_top_sequences(hospital_data_Plasmid$c_data),
  b = get_top_sequences(hospital_data_Plasmid$b_data),
  a = get_top_sequences(hospital_data_Plasmid$a_data)
)

plasmid_analysis <- analyze_overlap(top_plasmid, "Plasmid")

global_color_mapping_Plasmid <- create_color_mapping(plasmid_analysis$common, plasmid_analysis$unique)

plasmid_plots <- list(
  create_stacked_plot(hospital_data_Plasmid$a_data, top_plasmid$a, "A", "GENE", 
                     global_color_mapping_Plasmid) + labs(x = ""),
  create_stacked_plot(hospital_data_Plasmid$b_data, top_plasmid$b, "B", "GENE", 
                     global_color_mapping_Plasmid) + labs(y = ""),
  create_stacked_plot(hospital_data_Plasmid$c_data, top_plasmid$c, "C", "GENE", 
                     global_color_mapping_Plasmid, legend_ncol = 2) + labs(x = "", y = "")
)

legend_data_plasmid <- create_legend_data(plasmid_analysis$common, plasmid_analysis$unique, "GENE")
legend_plot_plasmid <- create_stacked_plot(legend_data_plasmid, plasmid_analysis$all, "Legend", 
                                        "GENE", global_color_mapping_Plasmid, show_legend = TRUE, legend_ncol = 2)
legend_grob_plasmid <- get_legend(legend_plot_plasmid)

combined_plot_genes <- create_combined_plot(plasmid_plots, legend_grob_plasmid, "Plasmid.png")
```

## INTEGRALL DB Analysis

#### Load Pertinent Files
```{r}
metadata <- read.csv("metadata_updated.csv", header = TRUE)
integrall_data <- read.delim("integrall_genemat.txt", header = TRUE)
integrall_lengths <- read.delim("integrall_length.txt", header = TRUE)
number_bases <- read.csv("bases_number.csv", header = TRUE)
```

#### Clean data
```{r}
integrall_data <- integrall_data %>%
  filter(rowSums(.[, -1]) > 0)

integrall_lengths <- integrall_lengths %>%
  filter(GENE %in% integrall_data$GENE)
```

#### Preprocessing
```{r}
combined_length <- merge (integrall_data, integrall_lengths, by = "GENE", all.x = TRUE)
combined_bases <- merge(number_bases, metadata, by = "SampleID", all.x = TRUE)

rownames(combined_length) <- combined_length$GENE

combined_length <- combined_length %>% select(-GENE)

# Note: Read length (150 bp) and number of bases in the sample are included, but do not affect relative abundance comparisons across genes or samples
integrall_length_norm <- combined_length[, 1:(ncol(combined_length)-1)]  / combined_length$Length
integrall_length_norm <- integrall_length_norm * 150

integrall_length_norm <- integrall_length_norm[ , order(names(integrall_length_norm))]

# Modify the B column** (Multiply by 10^9)
combined_bases <- combined_bases %>%
  mutate(B_transformed = (B * 10^9))

integrall_length_norm_t <- t(integrall_length_norm)
integrall_length_norm_t <- sweep(integrall_length_norm_t, 1, combined_bases$B_transformed, FUN = "/")

normalized_integrall <- t(integrall_length_norm_t)

normalized_integrall_df <- as.data.frame(normalized_integrall) %>%
  mutate(GENE = rownames(normalized_integrall)) %>%
  select(GENE, everything())

long_integrall <- normalized_integrall_df %>%
  pivot_longer(cols = -GENE, names_to = "SampleID", values_to = "Count")

combined_data <- merge(long_integrall,metadata, by = "SampleID", all.x = TRUE)
print(combined_data)

integrall_df <- combined_data %>%
  pivot_wider(names_from = GENE, values_from = Count)

print(integrall_df)
```

#### NOTE: Please run the helper functions above before running the code block below
### Generating Plot for INTEGRALL [Supplementary]
```{r}
hospital_data_integrall <- filter_hospital_data(combined_data)

top_integrall <- list(
  c = get_top_sequences(hospital_data_integrall$c_data),
  b = get_top_sequences(hospital_data_integrall$b_data),
  a = get_top_sequences(hospital_data_integrall$a_data)
)

integrall_analysis <- analyze_overlap(top_integrall, "Integrase")

global_color_mapping_integrall <- create_color_mapping(integrall_analysis$common, integrall_analysis$unique)

integrall_plots <- list(
  create_stacked_plot(hospital_data_integrall$a_data, top_integrall$a, "A", "GENE", 
                     global_color_mapping_integrall) + labs(x = ""),
  create_stacked_plot(hospital_data_integrall$b_data, top_integrall$b, "B", "GENE", 
                     global_color_mapping_integrall) + labs(y = ""),
  create_stacked_plot(hospital_data_integrall$c_data, top_integrall$c, "C", "GENE", 
                     global_color_mapping_integrall, legend_ncol = 2) + labs(x = "", y = "")
)

legend_data_integrall <- create_legend_data(integrall_analysis$common, integrall_analysis$unique, "GENE")
legend_plot_integrall <- create_stacked_plot(legend_data_integrall, integrall_analysis$all, "Legend", 
                                        "GENE", global_color_mapping_integrall, show_legend = TRUE, legend_ncol = 2)
legend_grob_integrall <- get_legend(legend_plot_integrall)

combined_plot_genes <- create_combined_plot(integrall_plots, legend_grob_integrall, "INTEGRALL.png")
```
