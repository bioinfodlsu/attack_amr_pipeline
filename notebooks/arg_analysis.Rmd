```         
```
## ARG Analysis File

```{r, libraries}
library(tidyverse)
library(RColorBrewer)
library(ggpubr)
library(plotly)
library(ggfortify)
library(ggrepel)
library(reshape2)
library(patchwork)
library(ggsignif)
library(gridExtra)
library(grid)
```

## Including Analysis

#### Load Pertinent Files

```{r}
metadata <- read.csv("metadata.csv", header = TRUE)
card_data_orig <- read.delim("ARG_genemat.txt", header = TRUE)
drug_class_card_orig <- read.delim("card_drug_class.txt", header = TRUE)
card_lengths_orig <- read.delim("card_length.txt", header = TRUE)
number_bases <- read.csv("bases_number.csv", header = TRUE)
```
#### Cleaning data
```{r}
card_data_orig <- card_data_orig %>%
  filter(rowSums(.[, -1]) > 0)

card_lengths_orig <- card_lengths_orig %>%
  filter(GENE %in% card_data_orig$GENE)

drug_class_card_orig <- drug_class_card_orig %>%
  filter(GENE %in% card_data_orig$GENE)
```

#### Merging Metadata and Normalizing Counts

```{r}
extract_gene_name <- function(full_name) {
  str_split_fixed(full_name, "\\|", 6)[,6]
}

card_data <- card_data_orig %>%
  mutate(GENE = extract_gene_name(GENE))

drug_class_card <- drug_class_card_orig %>%
  mutate(GENE = extract_gene_name(GENE))

card_lengths<- card_lengths_orig %>%
  mutate(GENE = extract_gene_name(GENE))

combined_length <- merge (card_data, card_lengths, by = "GENE", all.x = TRUE)
combined_bases <- merge(number_bases, metadata, by = "SampleID", all.x = TRUE)

rownames(combined_length) <- combined_length$GENE

combined_length <- combined_length %>% select(-GENE)

card_length_norm <- combined_length[, 1:(ncol(combined_length)-1)]  / combined_length$Length
card_length_norm <- card_length_norm * 150
card_length_norm <- card_length_norm[ , order(names(card_length_norm))]

card_length_norm_t <- t(card_length_norm)

combined_bases <- combined_bases %>%
  mutate(B_transformed = (B * 10^9) / (4.6 * 10^6))

card_length_norm_t <- t(card_length_norm)
card_length_norm_t <- sweep(card_length_norm_t, 1, combined_bases$B_transformed, FUN = "/")

normalized_card <- t(card_length_norm_t)

normalized_card_df <- as.data.frame(normalized_card) %>%
  mutate(GENE = rownames(normalized_card)) %>%
  select(GENE, everything())


long_card <- normalized_card_df %>%
  pivot_longer(cols = -GENE, names_to = "SampleID", values_to = "Count")

combined_data <- merge(long_card,metadata, by = "SampleID", all.x = TRUE)
print(combined_data)

combined_data_class <- merge(combined_data, drug_class_card, by = "GENE", all.x = TRUE)

card_df <- combined_data %>%
  pivot_wider(names_from = GENE, values_from = Count)

print(card_df)
```

### Cleaning Drug Classes

```{r}
combined_data_class <- combined_data_class %>%
  mutate(Class = str_replace_all(Class, "\\s*,\\s*", ";")) %>%
  mutate(num_classes = str_count(Class, ";") + 1) %>%
  mutate(Count_per_class = Count / num_classes) %>%
  separate_rows(Class, sep = ";") %>%
  mutate(Class = trimws(Class)) %>%
  select(-Count, -num_classes) %>%
  rename(Count = Count_per_class)

```

## Plots

## Relative abundances of Resistomes

### Function Helpers

#### Filter data by hospital
```{r}
filter_hospital_data <- function(data, hospitals = c("A", "B", "C")) {
  list(
    a_data = data %>% filter(hospital == "A"),
    b_data = data %>% filter(hospital == "B"),
    c_data = data %>% filter(hospital == "C")
  )
}
```

#### Get top ARG and drug classes
```{r}
get_top_classes <- function(data, item_col, n = 10) {
  data %>%
    group_by(.data[[item_col]]) %>%
    summarise(Percentage = (sum(Count, na.rm = TRUE) / sum(data$Count, na.rm = TRUE)) * 100, .groups = 'drop') %>%
    arrange(desc(Percentage)) %>%
    top_n(n, Percentage) %>%
    pull(.data[[item_col]])
}

get_top_genes <- function(data, n = 10) {
  data %>%
    group_by(SampleID) %>%
    summarise(TotalCount = sum(Count, na.rm = TRUE), .groups = 'drop') %>%
    right_join(data, by = "SampleID") %>%
    mutate(Percentage = (Count / TotalCount) * 100) %>%
    group_by(GENE) %>%
    summarise(AverageAbundance = mean(Percentage, na.rm = TRUE), .groups = 'drop') %>%
    arrange(desc(AverageAbundance)) %>%
    top_n(n, AverageAbundance) %>%
    pull(GENE)
}
```

# Find common and unique top drug classes and genes across hospitals
```{r}
analyze_overlap <- function(top_items_list, item_name) {
  common_items <- Reduce(intersect, top_items_list)
  all_top_items <- unique(unlist(top_items_list))
  unique_items <- setdiff(all_top_items, common_items)
  
  cat(paste("Common", item_name, "across all hospitals:", length(common_items), "\n"))
  cat(paste("Common", item_name, ":", paste(common_items, collapse = ", "), "\n"))
  cat(paste("Non-intersecting", item_name, ":", paste(unique_items, collapse = ", "), "\n\n"))
  
  list(common = common_items, unique = unique_items, all = all_top_items)
}
```

# Create color mapping
```{r}
create_color_mapping <- function(common_items, unique_items) {
  all_items <- c(common_items, unique_items)
  all_items <- setdiff(all_items, "Others")
  
  total_items <- length(all_items)
  palette <- colorRampPalette(brewer.pal(11, "Spectral"))(total_items)
  color_mapping <- setNames(palette, all_items)
  color_mapping["Others"] <- "#D2B48C"
  
  return(color_mapping)
}
```

# Create stacked bar plot
```{r}
create_stacked_plot <- function(data, top_items, hospital_name, item_col, color_mapping, 
                               show_legend = FALSE, legend_ncol = 1) {
  total_counts_per_sample <- data %>%
    group_by(SampleID) %>%
    summarise(TotalCount = sum(Count, na.rm = TRUE), .groups = 'drop')
  
  plot_data <- data %>%
    left_join(total_counts_per_sample, by = "SampleID") %>%
    mutate(
      Percentage = (Count / TotalCount) * 100,
      "{item_col}" := ifelse(.data[[item_col]] %in% top_items, .data[[item_col]], "Others")
    )
  
  factor_levels <- c("Others", names(color_mapping)[names(color_mapping) != "Others"])
  existing_levels <- intersect(factor_levels, unique(plot_data[[item_col]]))
  plot_data[[item_col]] <- factor(plot_data[[item_col]], levels = existing_levels)
  
  colors_to_use <- color_mapping[levels(plot_data[[item_col]])]
  colors_to_use <- colors_to_use[!is.na(colors_to_use)]
  
  p <- ggplot(plot_data, aes(x = SampleID, y = Percentage, fill = .data[[item_col]])) +
    geom_bar(stat = "identity", position = "stack", width = 0.7) +
    scale_fill_manual(values = colors_to_use) +
    labs(
      title = hospital_name,
      x = "Sample", 
      y = "Relative Abundance (%)"
    ) +
    theme_light() +
    theme(
      axis.text.x = element_text(size = 16, angle = 0, hjust = 0.5),
      axis.text.y = element_text(size = 16),
      axis.title.x = element_text(size = 18),
      axis.title.y = element_text(size = 18),
      plot.title = element_text(size = 20, face = "bold"),
      legend.title = element_blank(),
      legend.text = element_text(size = 16),
      aspect.ratio = 1
    ) +
    guides(fill = guide_legend(ncol = legend_ncol))
  
  if (!show_legend) {
    p <- p + theme(legend.position = "none")
  }
  
  return(p)
}
```

# Create legend and plot
```{r}
create_legend_data <- function(common_items, unique_items, item_col) {
  all_items <- c(common_items, unique_items, "Others")
  legend_data <- data.frame(
    SampleID = rep("Sample1", length(all_items)),
    Count = rep(1, length(all_items)),
    hospital = rep("Legend", length(all_items))
  )
  legend_data[[item_col]] <- all_items
  return(legend_data)
}

get_legend <- function(plot) {
  tmp <- ggplot_gtable(ggplot_build(plot))
  leg <- which(sapply(tmp$grobs, function(x) x$name) == "guide-box")
  legend <- tmp$grobs[[leg]]
  return(legend)
}
create_combined_plot <- function(plots, legend_grob, filename, width = 18, height = 5) {
  combined_plot <- grid.arrange(
    arrangeGrob(plots[[1]], plots[[2]], plots[[3]], ncol = 3),
    legend_grob,
    ncol = 2,
    widths = c(0.75, 0.25)
  )
  
  ggsave(filename = filename, plot = combined_plot, width = width, height = height, dpi = 300)
  grid.draw(combined_plot)
  
  return(combined_plot)
}
```

### Drug Classes
```{r}
hospital_data_class <- filter_hospital_data(combined_data_class)

top_classes <- list(
  c = get_top_classes(hospital_data_class$c_data, "Class"),
  b = get_top_classes(hospital_data_class$b_data, "Class"),
  a = get_top_classes(hospital_data_class$a_data, "Class")
)

class_analysis <- analyze_overlap(top_classes, "classes")

global_color_mapping_classes <- create_color_mapping(class_analysis$common, class_analysis$unique)

class_plots <- list(
  create_stacked_plot(hospital_data_class$a_data, top_classes$a, "A", "Class", 
                     global_color_mapping_classes) + labs(x = ""),
  create_stacked_plot(hospital_data_class$b_data, top_classes$b, "B", "Class", 
                     global_color_mapping_classes) + labs(y = ""),
  create_stacked_plot(hospital_data_class$c_data, top_classes$c, "C", "Class", 
                     global_color_mapping_classes) + labs(x = "", y = "")
)

legend_data_classes <- create_legend_data(class_analysis$common, class_analysis$unique, "Class")
legend_plot_classes <- create_stacked_plot(legend_data_classes, class_analysis$all, "Legend", 
                                          "Class", global_color_mapping_classes, show_legend = TRUE)
legend_grob_classes <- get_legend(legend_plot_classes)

combined_plot_classes <- create_combined_plot(class_plots, legend_grob_classes, "ARG_Drug_Class.png")

```

### Genes
```{r}
hospital_data_genes <- filter_hospital_data(combined_data)

top_genes <- list(
  c = get_top_genes(hospital_data_genes$c_data),
  b = get_top_genes(hospital_data_genes$b_data),
  a = get_top_genes(hospital_data_genes$a_data)
)

gene_analysis <- analyze_overlap(top_genes, "ARGs")

global_color_mapping_genes <- create_color_mapping(gene_analysis$common, gene_analysis$unique)

gene_plots <- list(
  create_stacked_plot(hospital_data_genes$a_data, top_genes$a, "A", "GENE", 
                     global_color_mapping_genes) + labs(x = ""),
  create_stacked_plot(hospital_data_genes$b_data, top_genes$b, "B", "GENE", 
                     global_color_mapping_genes) + labs(y = ""),
  create_stacked_plot(hospital_data_genes$c_data, top_genes$c, "C", "GENE", 
                     global_color_mapping_genes, legend_ncol = 2) + labs(x = "", y = "")
)

legend_data_genes <- create_legend_data(gene_analysis$common, gene_analysis$unique, "GENE")
legend_plot_genes <- create_stacked_plot(legend_data_genes, gene_analysis$all, "Legend", 
                                        "GENE", global_color_mapping_genes, show_legend = TRUE, legend_ncol = 2)
legend_grob_genes <- get_legend(legend_plot_genes)

combined_plot_genes <- create_combined_plot(gene_plots, legend_grob_genes, "ARG_GENE.png")
```

### Heatmap
```{r}
critically_important_args <- c(
  "AAC(6')-Ib'", "AAC(6')-Iid", "aadA", "adeJ", "adeK", "bacA", "bacA", "BEL-2", 
  "dfrA1", "dfrA12", "dfrA14", "dfrA15", "dfrA17", "dfrA23", "dfrA25", "dfrA5", 
  "EreA", "EreB", "ErmB", "ErmC", "ErmF", "ErmT", "floR", "FosA", 
  "GES-1", "GES-11", "GES-5", "IMP-1", "IMP-26", "IMP-4", "KPC-6", "lnuB", 
  "MCR-5.1", "mdtE", "mecA", "MexB", "MexI", "MOX-6", "mphA", "msrC", "NDM-1", 
  "NDM-5", "NDM-6", "NPS-1", "OXA-1", "OXA-10", "OXA-101", "OXA-119", "OXA-13", 
  "OXA-17", "OXA-2", "OXA-211", "OXA-212", "OXA-309", "OXA-333", "OXA-35", 
  "OXA-4", "OXA-5", "OXA-58", "PER-3", "SHV-5", "sul1", "sul2", "TEM-1", 
  "TEM-156", "TEM-169", "TEM-83", "tet(39)", "tet(A)", "tet(L)", "tet(M)",
  "tet(O)", "tet(Q)", "tet(W)", "VEB-3", "VEB-3", "VIM-1", "VIM-2"
)

filtered_data <- combined_data %>%
  filter(GENE %in% critically_important_args)

filtered_data <- filtered_data %>%
  mutate(GENE = if_else(GENE == "MCR-5.1", "mcr5", GENE)) %>%
  mutate(GENE = case_when(
    GENE %in% c("BEL-2", "GES-1", "GES-11", "GES-5", "IMP-1", "IMP-26", "IMP-4", 
                "KPC-6", "MOX-6", "NDM-1", "NDM-5", "NDM-6", "NPS-1", "OXA-1", 
                "OXA-10", "OXA-101", "OXA-119", "OXA-13", "OXA-17", "OXA-2", 
                "OXA-211", "OXA-212", "OXA-309", "OXA-333", "OXA-35", "OXA-4", 
                "OXA-5", "OXA-58", "PER-3", "SHV-5", "TEM-1", "TEM-156", 
                "TEM-169", "TEM-83", "VEB-3", "VIM-1", "VIM-2") ~ paste0("bla", GENE),
    TRUE ~ GENE
  ))

summary_data <- filtered_data %>%
  group_by(hospital, GENE) %>%
  summarize(Abundance = mean(Count, na.rm = TRUE), .groups = 'drop')

heatmap_data <- summary_data %>%
  pivot_wider(names_from = GENE, values_from = Abundance, values_fill = list(Abundance = 0)) %>%
  pivot_longer(cols = -hospital, names_to = "GENE", values_to = "Abundance")

heatmap_data <- heatmap_data %>%
  mutate(Presence = ifelse(Abundance > 0, 1, 0))

data_long <- heatmap_data %>%
  select(hospital, GENE, Presence)

unique_genes <- sort(unique(data_long$GENE))
n_genes <- length(unique_genes)
mid_point <- ceiling(n_genes / 2)

gene_groups <- data.frame(
  GENE = unique_genes,
  row = c(rep(1, mid_point), rep(2, n_genes - mid_point))
)

data_long <- data_long %>%
  left_join(gene_groups, by = "GENE")

# Create heatmap with facets for two rows
heatmap <- ggplot(data_long, aes(x = factor(GENE, levels = unique_genes), y = as.factor(hospital), fill = factor(Presence))) +
  geom_tile() +
  facet_wrap(~ row, scales = "free_x", nrow = 2, labeller = labeller(row = function(x) "")) +
  scale_fill_manual(
    values = c("0" = "white", "1" = "black"),
    labels = c("0" = "Absent", "1" = "Present"),
    guide = guide_legend(
      override.aes = list(
        color = c("black", "black"),
        linewidth = 0.5
      )
    )
  ) +
  labs(
    x = "ARGs",
    y = "Hospital", 
    fill = "Presence"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5, size = 14),
    axis.text.y = element_text(size = 14),
    axis.title.x = element_text(size = 14),
    axis.title.y = element_text(size = 14),
    plot.title = element_text(size = 14, hjust = 0.5),
    legend.title = element_text(size = 14),
    legend.text = element_text(size = 14),
    strip.text = element_text(size = 14, face = "bold"),
    panel.spacing = unit(1, "lines"),
    # Add border around legend keys to make "0" more visible
    legend.key = element_rect(color = "black", linewidth = 0.5),
    legend.key.size = unit(0.8, "cm")
  ) 
  
print(heatmap)
ggsave(filename = "Heatmap_ARGs.jpg",
       plot = heatmap,
       width = 16, height = 6, dpi = 300, units = "in", device = 'jpg', scale = 1)
```