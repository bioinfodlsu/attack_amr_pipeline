# Taxonomic Analysis

```{r, libraries}

library(tidyverse)
library(RColorBrewer)
library(ggpubr)
library(plotly)
library(ggfortify)
library(ggrepel)
library(reshape2)
library(patchwork)
library(ggsignif)
library(gridExtra)
library(grid)
```

### Load Metadata

```{r, warning=FALSE, error=FALSE, message=FALSE, results='hide', fig.show='hide'}
metadata <- read.csv("metadata.csv", header = TRUE)

```
#### Pre-processing (Only for Kraken)
```{r}
# Uncomment if using kraken 
taxonomic_data <- read.delim("merged_metakraken_abundance_table.txt", header = TRUE)
colnames(taxonomic_data) <- gsub("__profile", "", colnames(taxonomic_data))

```

#### Pre-processing (Only for Metaphlan)

```{r}
# Uncomment if using metaphlan
taxonomic_data <- read.delim("merged_abundance_table.txt", header = TRUE)
colnames(taxonomic_data)[colnames(taxonomic_data) == "clade_name"] <- "ID"

```
```{r}
long_taxonomic <- taxonomic_data %>%
pivot_longer(cols = -ID, names_to = "SampleID", values_to = "RelativeAbundance")


combined_data <- merge(long_taxonomic, metadata, by = "SampleID", all.x = TRUE)

wide_taxonomic <- combined_data %>%
  pivot_wider(names_from = ID, values_from = RelativeAbundance)

combined_data$Taxonomic_Level <- sapply(strsplit(as.character(combined_data$ID), "\\|"), function(x) length(x))

get_taxonomic_label <- function(name) {
  parts <- unlist(strsplit(name, "\\|"))
  
  switch(length(parts),
         "1" = "Kingdom",
         "2" = "Phylum",
         "3" = "Class",
         "4" = "Order",
         "5" = "Family",
         "6" = "Genus",
         "7" = "Species",
         "Other")
}

combined_data$Taxonomic_Label <- sapply(combined_data$ID, get_taxonomic_label)

extract_ID <- function(name) {
  parts <- unlist(strsplit(name, "\\|"))
  last_part <- parts[length(parts)]
  ID <- sub(".*__", "", last_part)
  return(ID)
}

combined_data$ID <- sapply(combined_data$ID, extract_ID)

combined_data <- combined_data[!is.na(combined_data$Taxonomic_Label) & combined_data$Taxonomic_Label != "Other", ]

all_taxonomic_data <- combined_data

list_of_data_frames <- combined_data %>%
  split(.$Taxonomic_Label)

kingdom_data <- list_of_data_frames$Kingdom
phylum_data <- list_of_data_frames$Phylum
class_data <- list_of_data_frames$Class
order_data <- list_of_data_frames$Order
family_data <- list_of_data_frames$Family
genus_data <- list_of_data_frames$Genus
species_data <- list_of_data_frames$Species

wide_genus_data <- genus_data %>%
  pivot_wider(names_from = ID, values_from = RelativeAbundance)

head(genus_data)
```

## Relative Abundance

### Function Helpers
#### Filter data by hospital
```{r}
filter_hospital_data <- function(data, hospitals = c("A", "B", "C")) {
  list(
    a_data = data %>% filter(hospital == "A"),
    b_data = data %>% filter(hospital == "B"),
    c_data = data %>% filter(hospital == "C")
  )
}
```

#### Get top sequences
```{r}
get_top_sequences <- function(data, n = 10) {
  data %>%
    group_by(SampleID) %>%
    summarise(TotalAbundance = sum(RelativeAbundance, na.rm = TRUE)) %>%
    right_join(data, by = "SampleID") %>%
    group_by(ID) %>%
    summarise(AverageAbundance = mean(RelativeAbundance, na.rm = TRUE)) %>%
    arrange(desc(AverageAbundance)) %>%
    top_n(n, AverageAbundance) %>%
    pull(ID)
}
```

#### Find common and unique top sequences across hospitals
```{r}
analyze_overlap <- function(top_items_list, item_name) {
  common_items <- Reduce(intersect, top_items_list)
  all_top_items <- unique(unlist(top_items_list))
  unique_items <- setdiff(all_top_items, common_items)
  
  cat(paste("Common", item_name, "across all hospitals:", length(common_items), "\n"))
  cat(paste("Common", item_name, ":", paste(common_items, collapse = ", "), "\n"))
  cat(paste("Non-intersecting", item_name, ":", paste(unique_items, collapse = ", "), "\n\n"))
  
  list(common = common_items, unique = unique_items, all = all_top_items)
}
```

#### Create color mapping
```{r}
create_color_mapping <- function(common_items, unique_items) {
  all_items <- c(common_items, unique_items)
  all_items <- setdiff(all_items, "Others")
  
  total_items <- length(all_items)
  palette <- colorRampPalette(brewer.pal(11, "Spectral"))(total_items)
  color_mapping <- setNames(palette, all_items)
  color_mapping["Others"] <- "#D2B48C"
  
  return(color_mapping)
}
```

#### Create stacked bar plot
```{r}
create_stacked_plot <- function(data, top_items, hospital_name, item_col, color_mapping, common_items, unique_items,
                               show_legend = FALSE, legend_ncol = 1) {
  plot_data <- data %>%
    mutate("{item_col}" := ifelse(.data[[item_col]] %in% top_items, .data[[item_col]], "Others"))
  factor_levels <- c("Others", common_items, unique_items)
  
  existing_levels <- intersect(factor_levels, unique(plot_data[[item_col]]))
  plot_data[[item_col]] <- factor(plot_data[[item_col]], levels = existing_levels)
  
  colors_to_use <- color_mapping[levels(plot_data[[item_col]])]
  colors_to_use <- colors_to_use[!is.na(colors_to_use)]
  
  p <- ggplot(plot_data, aes(x = SampleID, y = RelativeAbundance, fill = .data[[item_col]])) +
    geom_bar(stat = "identity", position = "stack", width = 0.7) +
    scale_fill_manual(values = colors_to_use) +
    labs(
      title = hospital_name,
      x = "Sample", 
      y = "Relative Abundance (%)"
    ) +
    theme_light() +
    theme(
      axis.text.x = element_text(size = 16, angle = 0, hjust = 0.5),
      axis.text.y = element_text(size = 16),
      axis.title.x = element_text(size = 18),                       
      axis.title.y = element_text(size = 18),  
      plot.title = element_text(size = 20, face = "bold"),
      legend.title = element_blank(),
      legend.text = element_text(size = 16, face = "italic"),
      aspect.ratio = 1 
    ) +
    guides(fill = guide_legend(ncol = legend_ncol))
  
  if (!show_legend) {
    p <- p + theme(legend.position = "none")
  }
  
  return(p)
}
```

#### Create legend and plot
```{r}
create_legend_data <- function(common_items, unique_items, item_col) {
  all_items <- c(common_items, unique_items, "Others")
  legend_data <- data.frame(
    SampleID = rep("Sample1", length(all_items)),
    ID = all_items,
    RelativeAbundance = rep(1, length(all_items)),
    hospital = rep("Legend", length(all_items))
  )
  legend_data[[item_col]] <- all_items
  return(legend_data)
}


get_legend <- function(plot) {
  tmp <- ggplot_gtable(ggplot_build(plot))
  leg <- which(sapply(tmp$grobs, function(x) x$name) == "guide-box")
  legend <- tmp$grobs[[leg]]
  return(legend)
}
create_combined_plot <- function(plots, legend_grob, filename, width = 18, height = 5) {
  combined_plot <- grid.arrange(
    arrangeGrob(plots[[1]], plots[[2]], plots[[3]], ncol = 3),
    legend_grob,
    ncol = 2,
    widths = c(0.75, 0.25)
  )
  
  ggsave(filename = filename, plot = combined_plot, width = width, height = height, dpi = 300)
  grid.draw(combined_plot)
  
  return(combined_plot)
}
```

### Generating Plot for Genus
```{r}
hospital_data_genus <- filter_hospital_data(genus_data)

top_genus <- list(
  c = get_top_sequences(hospital_data_genus$c_data),
  b = get_top_sequences(hospital_data_genus$b_data),
  a = get_top_sequences(hospital_data_genus$a_data)
)

genus_analysis <- analyze_overlap(top_genus, "genus")

global_color_mapping_genus <- create_color_mapping(genus_analysis$common, genus_analysis$unique)

genus_plots <- list(
    create_stacked_plot(hospital_data_genus$a_data, top_genus$a, "A", "ID", 
                       global_color_mapping_genus,
                       common_items = genus_analysis$common,
                       unique_items = genus_analysis$unique) + labs(x = ""),
    create_stacked_plot(hospital_data_genus$b_data, top_genus$b, "B", "ID", 
                       global_color_mapping_genus,
                       common_items = genus_analysis$common,
                       unique_items = genus_analysis$unique) + labs(y = ""),
    create_stacked_plot(hospital_data_genus$c_data, top_genus$c, "C", "ID", 
                       global_color_mapping_genus,
                       common_items = genus_analysis$common,
                       unique_items = genus_analysis$unique) + labs(x = "", y = "")
  )

legend_data_genus <- create_legend_data(genus_analysis$common, genus_analysis$unique, "ID")
legend_plot_genus <- create_stacked_plot(legend_data_genus, genus_analysis$all, "Legend", 
                                        "ID", global_color_mapping_genus, common_items = genus_analysis$common,
                                        unique_items = genus_analysis$unique, show_legend = TRUE, legend_ncol = 2)
legend_grob_genus <- get_legend(legend_plot_genus)

combined_plot_genes <- create_combined_plot(genus_plots, legend_grob_genus, "Genus.png")
```

### Generating Plot for Phylum
```{r}
hospital_data_phyla <- filter_hospital_data(phylum_data)

top_phyla <- list(
  c = get_top_sequences(hospital_data_phyla$c_data),
  b = get_top_sequences(hospital_data_phyla$b_data),
  a = get_top_sequences(hospital_data_phyla$a_data)
)

phyla_analysis <- analyze_overlap(top_phyla, "phyla")

global_color_mapping_phyla <- create_color_mapping(phyla_analysis$common, phyla_analysis$unique)

phyla_plots <- list(
    create_stacked_plot(hospital_data_phyla$a_data, top_phyla$a, "A", "ID", 
                       global_color_mapping_phyla,
                       common_items = phyla_analysis$common,
                       unique_items = phyla_analysis$unique) + labs(x = ""),
    create_stacked_plot(hospital_data_phyla$b_data, top_phyla$b, "B", "ID", 
                       global_color_mapping_phyla,
                       common_items = phyla_analysis$common,
                       unique_items = phyla_analysis$unique) + labs(y = ""),
    create_stacked_plot(hospital_data_phyla$c_data, top_phyla$c, "C", "ID", 
                       global_color_mapping_phyla,
                       common_items = phyla_analysis$common,
                       unique_items = phyla_analysis$unique) + labs(x = "", y = "")
  )

legend_data_phyla <- create_legend_data(phyla_analysis$common, phyla_analysis$unique, "ID")
legend_plot_phyla <- create_stacked_plot(legend_data_phyla, phyla_analysis$all, "Legend", 
                                        "ID", global_color_mapping_phyla, common_items = phyla_analysis$common,
                                        unique_items = phyla_analysis$unique, show_legend = TRUE, legend_ncol = 2)
legend_grob_phyla <- get_legend(legend_plot_phyla)

combined_plot_genes <- create_combined_plot(phyla_plots, legend_grob_phyla, "Phylum.png")
```

